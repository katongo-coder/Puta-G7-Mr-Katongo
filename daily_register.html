<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Register | Grade 7 Master System</title>
    <style>
        :root { 
            --primary: #2c3e50; 
            --accent: #3498db; 
            --light: #f4f7f6; 
            --success: #27ae60; 
            --danger: #e74c3c; 
            --warning: #f39c12;
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--light); display: flex; }
        
        /* Sidebar Styles */
        .sidebar { position: fixed; left: -260px; top: 0; height: 100%; width: 250px; background: var(--primary); color: white; transition: 0.3s; z-index: 100; padding-top: 20px; }
        .sidebar.active { left: 0; }
        .sidebar ul { list-style: none; padding: 0; }
        .sidebar li a { padding: 15px 25px; color: white; text-decoration: none; display: block; border-bottom: 1px solid #34495e; }
        .sidebar li:hover { background: var(--accent); }

        .menu-toggle { position: fixed; top: 20px; left: 20px; z-index: 101; background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }

        /* Main Content */
        .content { flex: 1; padding: 40px; transition: 0.3s; width: 100%; margin-top: 50px; }
        .sidebar.active ~ .content { margin-left: 250px; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid var(--accent); }
        .stat-card h3 { margin: 0; color: #7f8c8d; font-size: 14px; }
        .stat-card p { margin: 10px 0 0; font-size: 24px; font-weight: bold; color: var(--primary); }

        .search-container { margin-bottom: 20px; }
        #searchName { width: 100%; padding: 12px; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box; }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--accent); color: white; }
        tr:hover { background: #f9f9f9; cursor: pointer; }
        .present-row { background: #e8f5e9 !important; }

        .save-btn { background: var(--success); color: white; padding: 15px 30px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 20px; width: 100%; font-weight: bold; }
        
        .att-check { width: 20px; height: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="toggleMenu()">‚ò∞ Menu</button>
    
    <nav class="sidebar" id="sidebar">
        <div style="text-align: center; margin-bottom: 20px; padding: 10px;">
            <img id="user-photo" src="https://www.w3schools.com/howto/img_avatar.png" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid white; object-fit: cover;">
            <p id="user-display-name">Mr. Katongo 7B</p>
        </div>
        <ul>
            <li><a href="dashboard.html">üè† Dashboard</a></li>
            <li><a href="enrollment.html">üë• Grade 7 Enrollment</a></li>
            <li><a href="daily_register.html" style="background: var(--accent);">üìù Daily Register</a></li>
            <li><a href="mark_entry.html">üìä Enter Marks 2 Subjects</a></li>
            <li><a href="view_marks.html">üìú View Results 2 Subjects</a></li>
            <li><a href="daily_attendance_list.html">üìÇ Attendance Archives</a></li>
            <li><a href="mark_entry_all.html">üìÇ Enter All Subjects</a></li>
            <li><a href="all_subject_results.html">üìÇ View All Subjects</a></li>
            <li><a href="term_attendance.html">üìÇ Term Attendance</a></li>
            <li><a href="#" onclick="logout()" style="color: var(--danger);">üö™ Logout</a></li>
        </ul>
    </nav>

    <main class="content">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>Daily Attendance Register</h1>
            <h2 id="date-today" style="color: var(--accent);"></h2>
        </header>

        <div class="stats-grid">
            <div class="stat-card"><h3>Boys Present</h3><p id="count-boys">0</p></div>
            <div class="stat-card"><h3>Girls Present</h3><p id="count-girls">0</p></div>
            <div class="stat-card"><h3>Total Present</h3><p id="count-total">0</p></div>
        </div>

        <div class="search-container">
            <input type="text" id="searchName" placeholder="Search learner name..." onkeyup="filterTable()">
        </div>

        <table>
            <thead>
                <tr>
                    <th>Learner Name</th>
                    <th>Gender</th>
                    <th style="text-align: center;">Mark Present</th>
                </tr>
            </thead>
            <tbody id="reg-body"></tbody>
        </table>

        <button class="save-btn" onclick="saveAndGo()">‚úÖ Save Register & Sync to Database</button>
    </main>

    <script>
        // 1. Configuration
        const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbw_Q6JEuqKdrsA-ZK29XyLMMlLox2rCb0OzZPk_Gzgwrp0-43badQ1jGmnFQDoZqSVo/exec";
        const CLASS_NAME = "Grade 7B"; // Change this if used for a different class
        const ADMIN_PASS = "1234";

        if (localStorage.getItem('loggedIn') !== 'true') window.location.href = 'index.html';

        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); }

        function filterTable() {
            let input = document.getElementById("searchName").value.toUpperCase();
            let rows = document.querySelector("#reg-body").rows;
            for (let i = 0; i < rows.length; i++) {
                let name = rows[i].cells[0].textContent.toUpperCase();
                rows[i].style.display = name.includes(input) ? "" : "none";
            }
        }

        function updateStats() {
            const checkboxes = document.querySelectorAll('.att-check');
            let boys = 0, girls = 0;

            checkboxes.forEach((cb) => {
                if(cb.checked) {
                    const gender = cb.getAttribute('data-gender').toLowerCase();
                    if(gender === 'boy' || gender === 'male') boys++;
                    else if(gender === 'girl' || gender === 'female') girls++;
                }
            });

            document.getElementById('count-boys').innerText = boys;
            document.getElementById('count-girls').innerText = girls;
            document.getElementById('count-total').innerText = boys + girls;
        }

        function updateRowStyle(checkbox) {
            const row = checkbox.closest('tr');
            if(checkbox.checked) row.classList.add('present-row');
            else row.classList.remove('present-row');
        }

       

         async function saveAndGo() {
    const students = JSON.parse(localStorage.getItem('grade7C_data')) || [];
    if (students.length === 0) return alert("No students enrolled.");

    const checkboxes = document.querySelectorAll('.att-check');
    const today = new Date().toISOString().split('T')[0];
    let history = JSON.parse(localStorage.getItem('attendance_history')) || {};
    
    let presentList = [];
    let absentList = [];

    checkboxes.forEach((cb) => {
        const studentId = cb.getAttribute('data-id');
        const student = students.find(s => s.id == studentId);
        if(cb.checked) presentList.push(student); 
        else absentList.push(student); 
    });

    const bP = presentList.filter(s => s.gender.toLowerCase() === 'boy' || s.gender.toLowerCase() === 'male').length;
    const gP = presentList.filter(s => s.gender.toLowerCase() === 'girl' || s.gender.toLowerCase() === 'female').length;
    const bA = absentList.filter(s => s.gender.toLowerCase() === 'boy' || s.gender.toLowerCase() === 'male').length;
    const gA = absentList.filter(s => s.gender.toLowerCase() === 'girl' || s.gender.toLowerCase() === 'female').length;

    const payload = {
        className: CLASS_NAME,
        enrollment: students.length,
        bP: bP,
        gP: gP,
        totalP: presentList.length,
        bA: bA,
        gA: gA,
        totalA: absentList.length,
        performance: ((presentList.length / students.length) * 100).toFixed(1)
    };

    // FIX: Send as JSON instead of URLSearchParams
    try {
        await fetch(SHEET_API_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        
        history[today] = { present: presentList, absent: absentList };
        localStorage.setItem('attendance_history', JSON.stringify(history));
        alert("‚úÖ Synced to Database successfully!");
        window.location.href = 'daily_attendance_list.html';
    } catch (e) {
        alert("‚ö†Ô∏è Connection Error. Data saved locally only.");
    }
}
            

        function logout() {
            localStorage.removeItem('loggedIn');
            window.location.href = 'index.html';
        }

        window.onload = () => {
            const savedPic = localStorage.getItem('profile_pic');
            if(savedPic) document.getElementById('user-photo').src = savedPic;
            
            document.getElementById('date-today').innerText = new Date().toDateString();
            
            const students = JSON.parse(localStorage.getItem('grade7C_data')) || [];
            const tableBody = document.getElementById('reg-body');

            if(students.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No students enrolled. Go to Enrollment page first.</td></tr>';
                return;
            }

            tableBody.innerHTML = students.map((s) => `
                <tr onclick="const cb = this.querySelector('.att-check'); cb.checked = !cb.checked; updateRowStyle(cb); updateStats();">
                    <td>${s.name}</td>
                    <td>${s.gender}</td>
                    <td style="text-align: center;">
                        <input type="checkbox" class="att-check" 
                               data-gender="${s.gender}" 
                               data-id="${s.id}"
                               onclick="event.stopPropagation(); updateRowStyle(this); updateStats();">
                    </td>
                </tr>
            `).join('');
        };
    </script>
</body>
</html>