<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enrollment | Grade 7B System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { 
            --primary: #2c3e50; --accent: #3498db; --light: #f4f7f6; 
            --danger: #e74c3c; --success: #27ae60; --warning: #f39c12;
            --purple: #8e44ad;
        }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--light); display: flex; }

        /* Sidebar */
        #sidebar { width: 260px; background: var(--primary); color: white; height: 100vh; position: fixed; left: -260px; transition: 0.4s; z-index: 1000; }
        #sidebar.active { left: 0; }
        .profile-area { padding: 30px; text-align: center; border-bottom: 1px solid #34495e; }
        .profile-img { width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--accent); object-fit: cover; }
        nav ul { list-style: none; padding: 0; }
        nav li a { padding: 15px 25px; display: block; color: white; text-decoration: none; border-bottom: 1px solid #34495e; }
        nav li a:hover { background: #34495e; }
        
        /* Layout */
        .main-content { flex: 1; padding: 40px; transition: 0.4s; width: 100%; }
        .main-content.shifted { margin-left: 260px; }
        .menu-toggle { position: fixed; top: 20px; left: 20px; z-index: 1001; background: var(--primary); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; }

        /* Stats & Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-bottom: 4px solid var(--accent); }
        .form-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .grid-inputs { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; }
        
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: opacity 0.3s; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-add { background: var(--success); }
        .btn-sync { background: var(--purple); }
        .btn-backup { background: var(--accent); }
        .btn-restore { background: var(--warning); }
        .btn-pdf { background: #5d6d7e; }
        .btn-clear { background: var(--danger); float: right; }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; margin-top: 20px; }
        th { background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        .enroll-no { color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="toggleMenu()">‚ò∞ Menu</button>

    <div id="sidebar">
        <div class="profile-area">
            <img src="https://www.w3schools.com/howto/img_avatar.png" class="profile-img">
            <h3>Mr. Katongo<br><small>Grade 7B Teacher</small></h3>
        </div>
        <nav>
            <ul>
                <li><a href="dashboard.html">üè† Dashboard</a></li>
                <li><a href="enrollment.html">üë• Grade 7 Enrollment</a></li>
                <li><a href="mark_entry.html">üìä Enter Marks</a></li>
                <li><a href="view_marks.html">üìú View Results</a></li>
                <li><a href="index.html" style="color: var(--danger);">üö™ Logout</a></li>
            </ul>
        </nav>
    </div>

    <div class="main-content" id="main">
        <h1>Learner Enrollment</h1>

        <div class="stats-grid">
            <div class="stat-card"><h3>Boys</h3><p id="stat-boys">0</p></div>
            <div class="stat-card"><h3>Girls</h3><p id="stat-girls">0</p></div>
            <div class="stat-card" style="border-color: var(--success);"><h3>Total</h3><p id="stat-total">0</p></div>
        </div>
        
        <div class="form-card">
            <div class="grid-inputs">
                <input type="text" id="stu-name" placeholder="Full Name">
                <select id="stu-gender">
                    <option value="Boy">Boy</option>
                    <option value="Girl">Girl</option>
                </select>
                <button class="btn btn-add" onclick="addLearner()">Enroll Student</button>
            </div>
        </div>

        <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px;">
            <button class="btn btn-sync" id="syncBtn" onclick="syncToCloud()">‚òÅÔ∏è Sync to Google Sheets</button>
            <button class="btn btn-backup" onclick="backupData()">üì• Backup (JSON)</button>
            <button class="btn btn-restore" onclick="document.getElementById('fileInput').click()">üì§ Restore/Merge</button>
            <input type="file" id="fileInput" style="display:none" onchange="restoreData(event)">
            <button class="btn btn-pdf" onclick="downloadPDF()">üìÑ Download PDF Report</button>
            <button class="btn btn-clear" onclick="clearAllData()">‚ö†Ô∏è Clear All</button>
        </div>

        <table id="enrollment-table">
            <thead>
                <tr>
                    <th>Enrollment No.</th>
                    <th>Name</th>
                    <th>Gender</th>
                    <th>Enrolled By</th>
                    <th>Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="stu-table"></tbody>
        </table>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyMu8ARurv7ECl-zMu5ZnL13dONDXtfNy5zUlKIEEKz8g0O41XqjoGfhQuHgGLmA-Hl/exec"; // PASTE YOUR DEPLOYED URL HERE
        const ACCESS_CODE = "1234";

        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('main').classList.toggle('shifted');
        }

        // --- ENROLLMENT LOGIC ---
        function addLearner() {
            const nameInput = document.getElementById('stu-name');
            const gender = document.getElementById('stu-gender').value;
            const name = nameInput.value.trim();
            
            if(!name) return alert("Please enter a name");

            let students = JSON.parse(localStorage.getItem('grade7C_data')) || [];
            
            // Check for potential duplicate in local list
            if(students.find(s => s.name.toLowerCase() === name.toLowerCase())) {
                if(!confirm("A student with this name already exists. Enroll anyway?")) return;
            }

            const enrollNo = `G7C-${new Date().getFullYear()}-${(students.length + 1).toString().padStart(3, '0')}`;

            const newStudent = { 
                id: Date.now(), 
                enrollNo: enrollNo,
                name: name, 
                gender: gender, 
                enrolledBy: "Mr. Katongo",
                enrollDate: new Date().toLocaleDateString('en-GB')
            };

            students.push(newStudent);
            localStorage.setItem('grade7C_data', JSON.stringify(students));
            nameInput.value = '';
            renderTable();

            // Automatically try to sync this single entry to Google Sheets
            syncSingle(newStudent);
        }

        // --- CLOUD SYNC LOGIC ---
        async function syncSingle(student) {
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ type: "single_entry", student: student })
                });
            } catch (e) { 
                console.log("Offline or Sync Failed: Saved to local storage only."); 
            }
        }

        async function syncToCloud() {
            const btn = document.getElementById('syncBtn');
            const students = JSON.parse(localStorage.getItem('grade7C_data')) || [];
            
            if(students.length === 0) return alert("No students to sync.");
            
            btn.innerText = "‚åõ Syncing...";
            btn.disabled = true;

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ type: "bulk_sync", students: students })
                });
                alert("Success: All learners synced to Google Sheets. Existing records were skipped.");
            } catch (e) {
                alert("Sync failed. Check your internet connection or SCRIPT_URL configuration.");
            } finally {
                btn.innerText = "‚òÅÔ∏è Sync to Google Sheets";
                btn.disabled = false;
            }
        }

        // --- TABLE & UTILITIES ---
        function renderTable() {
            const students = JSON.parse(localStorage.getItem('grade7C_data')) || [];
            const tbody = document.getElementById('stu-table');
            
            const boys = students.filter(s => s.gender === 'Boy').length;
            const girls = students.filter(s => s.gender === 'Girl').length;
            document.getElementById('stat-boys').innerText = boys;
            document.getElementById('stat-girls').innerText = girls;
            document.getElementById('stat-total').innerText = students.length;

            tbody.innerHTML = students.map(s => `
                <tr>
                    <td class="enroll-no">${s.enrollNo || 'N/A'}</td>
                    <td><b>${s.name}</b></td>
                    <td>${s.gender}</td>
                    <td>${s.enrolledBy || 'Mr. Katongo'}</td>
                    <td>${s.enrollDate}</td>
                    <td><button onclick="deleteLearner(${s.id})" style="color:red; border:none; background:none; cursor:pointer;">Remove</button></td>
                </tr>
            `).join('');
        }

        function deleteLearner(id) {
            if (prompt("Enter Access Code to Remove Student:") === ACCESS_CODE) {
                let students = JSON.parse(localStorage.getItem('grade7C_data')) || [];
                students = students.filter(s => s.id !== id);
                localStorage.setItem('grade7C_data', JSON.stringify(students));
                renderTable();
            } else {
                alert("Incorrect Access Code.");
            }
        }

        function backupData() {
            const data = localStorage.getItem('grade7C_data');
            const blob = new Blob([data], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Grade7C_Enrollment_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function restoreData(event) {
            const reader = new FileReader();
            reader.onload = function(e) {
                if(prompt("Enter Access Code to Restore Data:") === ACCESS_CODE) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        let current = JSON.parse(localStorage.getItem('grade7C_data')) || [];
                        imported.forEach(imp => {
                            if(!current.find(c => c.id === imp.id)) current.push(imp);
                        });
                        localStorage.setItem('grade7C_data', JSON.stringify(current));
                        renderTable();
                        alert("Data Merged Successfully!");
                    } catch (err) {
                        alert("Error: Invalid backup file.");
                    }
                }
            };
            reader.readAsText(event.target.files[0]);
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const students = JSON.parse(localStorage.getItem('grade7C_data')) || [];
            
            const boys = students.filter(s => s.gender === 'Boy').length;
            const girls = students.filter(s => s.gender === 'Girl').length;

            doc.setFontSize(18);
            doc.text("Grade 7C Enrollment Report", 14, 20);
            
            const tableData = students.map(s => [
                s.enrollNo || 'N/A', 
                s.name, 
                s.gender, 
                s.enrolledBy || 'Mr. Katongo', 
                s.enrollDate
            ]);

            doc.autoTable({
                head: [['Enroll No', 'Name', 'Gender', 'Enrolled By', 'Date']],
                body: tableData,
                startY: 30,
                theme: 'striped',
                headStyles: { fillColor: [44, 62, 80] }
            });

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.text(`SUMMARY: Boys: ${boys} | Girls: ${girls} | Total: ${students.length}`, 14, finalY);

            doc.save(`Grade7C_Enrollment_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function clearAllData() {
            if(prompt("WARNING: Type '" + ACCESS_CODE + "' to PERMANENTLY WIPE ALL LOCAL DATA:") === ACCESS_CODE) {
                localStorage.setItem('grade7C_data', "[]");
                renderTable();
            }
        }

        window.onload = renderTable;
    </script>
</body>
</html>